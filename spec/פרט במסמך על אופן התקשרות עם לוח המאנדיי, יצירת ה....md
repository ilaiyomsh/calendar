# **מפרט טכני: אינטגרציית יומן דיווח שעות עם Monday.com**

מסמך זה מתאר את הארכיטקטורה והלוגיקה למימוש אפליקציית יומן לדיווח שעות, המסונכרנת בזמן אמת עם לוח Monday.

## **1\. הגדרת לוח המאנדיי (Board Setup)**

כדי שהאינטגרציה תעבוד בצורה חלקה, הלוח במאנדיי חייב להכיל את העמודות הבאות. המזהים (IDs) של העמודות הם קריטיים לקוד.

| שם עמודה (תצוגה) | סוג עמודה (Type) | מזהה מומלץ (ID) | הגדרות נדרשות | תפקיד במערכת |
| ----: | ----: | ----: | ----: | ----: |
| **משימה / נושא** | Name | name | ברירת מחדל | כותרת האירוע ביומן. |
| **תאריך והתחלה** | Date | date4 (או דומה) | **חובה:** להפעיל "Add Time" בהגדרות העמודה. | נקודת העוגן של האירוע (יום ושעה מדויקת). |
| **משך זמן** | Hour | hour | ברירת מחדל | אורך האירוע בשעות ודקות (למשל 01:30). |
| **סוג פעילות** | Status | status | תוויות צבעוניות | קביעת צבע האירוע ביומן (למשל: כחול=פיתוח, ירוק=פגישה). |

## **2\. יצירת אירוע חדש (Create Item Flow)**

תהליך יצירת אירוע מתרחש כאשר המשתמש לוחץ על כפתור "שמור" בחלונית הדיאלוג שיצרנו.

### **א. קלט מהמשתמש**

המשתמש מזין בממשק:

1. **תאריך:** (למשל 21/11/2023)  
2. **שעת התחלה:** (למשל 10:00)  
3. **שעת סיום:** (למשל 11:30)  
4. **נושא:** (למשל "פגישת אפיון")

### **ב. לוגיקת עיבוד (Frontend Logic)**

לפני השליחה למאנדיי, עלינו לחשב את הנתונים לפורמט המתאים:

1. **חישוב משך הזמן (Duration):**  
   * מחשבים את ההפרש במילי-שניות: End Time \- Start Time.  
   * ממירים לשעות ודקות (למשל: 90 דקות \-\> 1 שעה, 30 דקות).  
2. **פרמוט תאריך התחלה:**  
   * מפרידים לתאריך (YYYY-MM-DD) ושעה (HH:MM:SS).

### **ג. שאילתת השמירה (GraphQL Mutation)**

אנו משתמשים ב-Mutation של create\_item.

mutation ($boardId: ID\!, $itemName: String\!, $columnValues: JSON\!) {  
  create\_item (  
    board\_id: $boardId,  
    item\_name: $itemName,  
    column\_values: $columnValues  
  ) {  
    id  
  }  
}

**מבנה ה-JSON שנשלח (columnValues):**

{  
  "date4": { "date": "2023-11-21", "time": "10:00:00" },  
  "hour": { "hour": 1, "minute": 30 },  
  "status": { "label": "פגישה" }  
}

## **3\. משיכה והצגה דינמית (Fetch & Render Flow)**

כדי למנוע עומס, אנו שולפים רק את האירועים הרלוונטיים לתצוגה הנוכחית.

### **א. טריגר לשליפה**

הפונקציה fetchEvents נקראת בשני מקרים:

1. **טעינה ראשונית:** בעליית האפליקציה (ברירת מחדל: השבוע הנוכחי).  
2. **שינוי טווח:** כאשר המשתמש לוחץ על "הבא/הקודם" או משנה תצוגה (שבוע/חודש). הרכיב Calendar מפעיל את onRangeChange ומספק את ה-start וה-end של התצוגה החדשה.

### **ב. שאילתת השליפה (Filtered Query)**

אנו משתמשים ב-API החדש של מאנדיי (items\_page) עם סינון לפי עמודת התאריך.

query ($boardId: ID\!, $fromDate: String\!, $toDate: String\!) {  
  boards (ids: \[$boardId\]) {  
    items\_page (  
      limit: 500,  
      query\_params: {  
        rules: \[  
          {  
            column\_id: "date4",  
            compare\_value: \[$fromDate, $toDate\],  
            operator: between  
          }  
        \]  
      }  
    ) {  
      items {  
        id  
        name  
        column\_values {  
          id  
          text  
          value  
          type  
        }  
      }  
    }  
  }  
}

### **ג. מיפוי וחישוב לתצוגה (Mapping)**

המידע מגיע ממאנדיי בצורה "גולמית". עלינו להפוך אותו לאובייקטי אירוע שהלוח מכיר.

**אלגוריתם המיפוי (לכל פריט):**

1. **חילוץ התחלה:** קרא את ה-JSON מעמודת date4 \-\> צור אובייקט Date (נקרא לו start).  
2. **חילוץ משך:** קרא את ה-JSON מעמודת hour. אם אין ערך, קבע ברירת מחדל (למשל שעה).  
   * durationMinutes \= (hour \* 60\) \+ minute  
3. **חישוב סיום:**  
   * end \= new Date(start.getTime() \+ durationMinutes \* 60000\)  
4. **יצירת האובייקט:**  
   {  
     id: item.id,  
     title: item.name,  
     start: start,  
     end: end,  
     color: extractColorFromStatus(item) // פונקציית עזר לצבע  
   }

### **ד. תצוגה**

מערך האירועים המעובד נכנס ל-State של הקומפוננטה (setEvents), והלוח מתרנדר מחדש ומציג את האירועים במשבצות המדויקות.

## **4\. תרשים זרימה מסכם**

sequenceDiagram  
    participant User as משתמש  
    participant App as אפליקציית יומן  
    participant Monday as Monday API

    User-\>\>App: פתיחת יומן / שינוי שבוע  
    App-\>\>Monday: שאילתת items\_page (עם טווח תאריכים)  
    Monday--\>\>App: רשימת פריטים (JSON גולמי)  
    App-\>\>App: חישוב שעת סיום (התחלה \+ משך)  
    App--\>\>User: הצגת אירועים בלוח

    User-\>\>App: יצירת אירוע חדש (בחירת שעות)  
    App-\>\>App: חישוב משך זמן (סיום \- התחלה)  
    App-\>\>Monday: mutation create\_item (תאריך \+ משך)  
    Monday--\>\>App: אישור (Item ID)  
    App-\>\>App: הוספת האירוע ללוח מקומית (Optimistic UI)  
